---
name: Database Setup & Usage
description: Instructions for setting up and working with the PostgreSQL database using Drizzle ORM
applyTo: '**/*.{ts,tsx}'
---

# Database Setup & Usage

This document contains instructions for setting up and working with the database.

## Prerequisites

- Docker and Docker Compose installed
- Node.js (or Bun) installed

## Getting Started

### 1. Start the PostgreSQL Database

```bash
docker-compose up -d
```

This will start a PostgreSQL 17 container with:

- Database: `cindral`
- User: `postgres`
- Password: `postgres`
- Port: `5432`

### 2. Push the Schema to the Database

For rapid development without migration files:

```bash
bun run db:push
```

Or generate and run migrations:

```bash
bun run db:generate
bun run db:migrate
```

### 3. Open Drizzle Studio (Optional)

To visually browse and edit your database:

```bash
bun run db:studio
```

This will open a browser-based database GUI at `https://local.drizzle.studio`

## Database Commands

| Command               | Description                                       |
| --------------------- | ------------------------------------------------- |
| `bun run db:generate` | Generate SQL migration files from schema changes  |
| `bun run db:migrate`  | Apply pending migrations to the database          |
| `bun run db:push`     | Push schema changes directly (no migration files) |
| `bun run db:studio`   | Open Drizzle Studio database browser              |

## Development Workflow

### When to use `db:push` vs `db:migrate`

**Use `db:push` when:**

- Rapidly prototyping
- Working on local development
- You don't need a migration history

**Use `db:generate` + `db:migrate` when:**

- Working on production schema changes
- You need a migration history
- Collaborating with a team
- Deploying to production

### Making Schema Changes

1. Edit the schema in [src/db/schema.ts](src/db/schema.ts)
2. Push changes: `bun run db:push`
   - Or generate migration: `bun run db:generate`
   - Then apply: `bun run db:migrate`

## Database Connection

The database URL is configured in `.env.local`:

```
DATABASE_URL=postgres://postgres:postgres@localhost:5432/cindral
```

## Schema Overview

The database schema is managed in two files:

- **`auth-schema.ts`** - Generated by better-auth CLI (don't edit manually)
- **`src/db/schema.ts`** - Your main schema file that imports auth tables and adds your app tables

### Auth Schema (Generated)

The auth schema is auto-generated by better-auth:

```bash
bunx @better-auth/cli generate
```

This creates/updates `auth-schema.ts` with tables for:

- **user** - User accounts
- **session** - Active sessions
- **account** - OAuth accounts & passwords
- **verification** - Email verification tokens
- **organization** - Organizations/tenants
- **member** - Organization memberships
- **invitation** - Pending invitations

### App Schema

`src/db/schema.ts` imports the auth tables and adds your application tables:

- Re-exports all auth tables and relations
- Defines your custom tables (e.g., `posts`)
- Extends relations (e.g., adding `posts` to `user`)

**Example:**

```typescript
import { user, organization } from '../../auth-schema'

export const posts = pgTable('posts', {
  // ...
  userId: text('user_id').references(() => user.id),
  organizationId: text('organization_id').references(() => organization.id),
})
```

## Using the Database in tRPC

The database is available in tRPC context as `ctx.db`. Example:

```typescript
// Get all users
const users = await opts.ctx.db.select().from(users)

// Create a user
const [newUser] = await opts.ctx.db.insert(users).values({ name: 'John', email: 'john@example.com' }).returning()
```

## Stopping the Database

```bash
docker-compose down
```

To remove the volume (delete all data):

```bash
docker-compose down -v
```

## Troubleshooting

### Connection refused

- Make sure Docker is running
- Check if the container is running: `docker ps`
- Start the container: `docker-compose up -d`

### Port already in use

- Another PostgreSQL instance might be running on port 5432
- Stop the other instance or change the port in `docker-compose.yml`

### Schema changes not applying

- Try `bun run db:push` to push schema changes directly
- Check Drizzle Studio to verify the schema
